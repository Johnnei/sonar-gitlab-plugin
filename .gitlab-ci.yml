image: maven:3.3.9-jdk-8

variables:
  DOCKER_DRIVER: overlay2

stages:
    - build
    - test
    - integration
    - qa

build-package:
    stage: build
    script: "mvn -B package -DskipTests -Ddocker.skip"
    artifacts:
      paths:
      - "target/sonar-gitlab-plugin-*.jar"

quicktests:
    stage: test
    script: "mvn -B test --fail-at-end"
    artifacts:
      expire_in: 1 week
      paths:
      - "target/jacoco.exec"

sonarqube.johnnei.org:
    stage: qa
    script: "mvn -B compile test-compile sonar:sonar -Dsonar.host.url=https://sonarqube.johnnei.org -Dsonar.branch=$CI_BUILD_REF_NAME"
    except: ["master"]
    dependencies: ["quicktests"]

sonarqube.com:
    stage: qa
    script: "mvn -B compile test-compile sonar:sonar -Dsonar.host.url=https://www.sonarqube.com -Dsonar.login=$SONAR_TOKEN"
    only: ["develop","feature/SGP-7"]
    dependencies: ["quicktests"]

SQ-LTS-GitLab-8.14:
    image: localhost:5000/dind-maven:latest
    stage: integration
    services: ["docker:dind"]
    dependencies: []
    tags: ["dind"]
    before_script:
    - "mvn --version"
    - "docker info"
    script:
    - "docker pull gitlab/gitlab-ce"
    - "docker pull sonarqube:lts"
    - "mvn -B verify -Ddocker.provider=remote"
